<!doctype html>
<html lang="ru">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Блог компании Яндекс.</title>
</head>

<body>
    <div>
        <h1>ЯНДЕКС.ПОЧТА: КАК МЫ ИЗМЕРЯЕМ СКОРОСТЬ ЗАГРУЗКИ И УЛУЧШАЕМ ЕЁ</h1>
        <p align="left">Eсли ваш сайт медленно грузится, вы рискуете тем, что люди не оценят ни то,<br>
            какой он красивый, ни то, какой он удобный. Никому не понравится, когда все<br>
            тормозит. Мы регулярно добавляем в Яндекс.Почту новую функциональность,<br>
            иногда — исправляем ошибки, а это значит, у нас постоянно появляются новый код<br>
            и новая логика. Всё это напрямую влияет на скорость работы интерфейса.</p>
    </div>
    <div>
        <h2>Что мы измеряем</h2>

        <p>Этапы первой загрузки:</p>
        <ul>
            <li>подготовка;</li>
            <li>загрузка статики (HTTP-запрос и парсинг);</li>
            <li>исполнение модулей;</li>
            <li>инициализация базовых объектов;</li>
            <li>отрисовка</li>
        </ul>
        <p>Этапы отрисовки любой страницы:</p>
        <ul>
            <li>подготовка к запросу на сервер;</li>
            <li>запрос данных с сервера;</li>
            <li>шаблонизация;</li>
            <li>обновление DOM.</li>
        </ul>
    </div>
    <div>
        <p>— «Ок, теперь у нас есть метрики, мы можем отправить их на сервер» - говорим мы</p>
        <p>— «Что же дальше?» - вопрошаете вы</p>
        <p>— «А давай построим график!» - отвечаем мы</p>
        <p>— «А что будем считать?» - уточняете вы</p>
        <p>Как вы знаете, медиана – это серединное, а не среднее значение в выборке.<br>
            Если у нас имеются числа 1, 2, 2, 3, 8, 10, 20, то медиана – 3, а среднее – 6,5.<br>
            В общем случае медиана отлично показывает, сколько грузится средний пользователь.</p>
        <p>В случае ускорения или замедления медиана, конечно, изменится. Но она не может<br>
            рассказать, сколько пользователей ускорилось, а сколько замедлилось.</p>
        <p>APDEX – метрика, которая сразу говорит: хорошо или плохо. Метрика<br>
            работает очень просто. Мы выбираем временной интервал [0; t], такой, что если<br>
            время показа страницы попало в него, то пользователь счастлив. Берем еще один<br>
            интервал, (t; 4t] (в четыре раза больше первого), и считаем, что если страница<br>
            показана за это время, то пользователь в целом удовлетворен скоростью работы,<br>
            но уже не настолько счастлив. И применяем формулу:</p>
        <p>(кол-во счастливых пользователей + кол-во удовлетворенных / 2) / (кол-во всех).<br>
            Получается значение от нуля до единицы, которое, видимо, лучше всего показывает,<br>
            хорошо или плохо работает почта.</p>
    </div>
    <div>
        <h2>Как мы измеряем</h2>
        <p>Сейчас модуль обновления сам логирует все свои стадии, и можно легко понять<br>
            причину замедления: медленнее стал отвечать сервер либо слишком долго<br>
            выполняется JavaScript. Выглядит это примерно так:</p>
        <p><code>this.timings['look-ma-im-start'] = Date.now();<br>
                this.timings['look-ma-finish'] = Date.now();</code></p>
        <p>C помощью Date.now() мы получаем текущее время. Все тайминги собираются и при<br>
            отправке рассчитываются. На этапах разница между “end” и “start” не считается,<br>
            а все вычисления производятся в конце:</p>
        <p><code>var totalTime = this.timings['look-ma-finish'] - this.timings['look-ma-im-start'];</code></p>
        <p>И на сервер прилетают подобные записи:</p>
        <p><code>serverResponse=50&domUpdate=60</code></p>
    </div>
    <div>
        <h2>Как мы ускоряем</h2>
        <p>Чтобы снизить время загрузки почты при выходе новых версий,<br>
            мы уже делаем следующее:</p>
        <ul>
            <li>включаем gzip;</li>
            <li>выставляем заголовки кэширования;</li>
            <li>фризим CSS, JS, шаблоны и картинки;</li>
            <li>используем CDN;</li>
        </ul>
        <p>Мы подумали: «А что если хранить где-то старую версию файлов, а при выходе новой<br>
            передавать только diff между ней и той, которая сохранена у пользователя?»<br>
            В браузере же останется просто наложить патч на клиенте.</p>
        <p>На самое деле эта идея не нова. Уже существуют стандарты для HTTP — например,<br>
            RFC 3229 «Delta encoding in HTTP» и «Google SDHC», — но по разным причинам они<br>
            не получили должного распространения в браузерах и на серверах.</p>
        <p>Мы же решили сделать свой аналог на JS. Чтобы реализовать этот метод обновления,<br>
            начали искать реализации diff на JS. На популярных хостингах кода нашли<br>
            библиотеки:</p>
        <p>- VCDiff</p>
        <p>- google-diff-patch-match</p>
        <p>Для окончательного выбора библиотеки нам нужно сравнить:</p>
        <table rules="cols">
            <tr>
                <td width="150">Библиотека</td>
                <td width="150">IE 9</td>
                <td width="150">Opera 12</td>
            </tr>
            <tr>
                <td>&ndash;&nbsp;&ndash;&nbsp;&ndash;&nbsp;&ndash;&nbsp;</td>
                <td>&ndash;&nbsp;&ndash;&nbsp;&ndash;&nbsp;&ndash;&nbsp;</td>
                <td>&ndash;&nbsp;&ndash;&nbsp;&ndash;&nbsp;&ndash;&nbsp;</td>
            </tr>
            <tr>
                <td>vcdiff</td>
                <td>8</td>
                <td>5</td>
            </tr>
            <tr>
                <td>google diff</td>
                <td>1363</td>
                <td>76</td>
            </tr>
        </table>
    </div>
    <div>
        <p>После того как мы определились с библиотекой для диффа, нужно определиться с тем,<br>где и как хранить
            статику на клиенте.</p>
        <p>Формат файла с патчами для проекта выглядит так:</p>
        <pre>
<code>[
         {
            "k": "jane.css",
            "p": [patch],
            "s": 4554
         },
         {
            "k": "jane.css",
            "p": [patch],
            "s": 4554
         }
]</code>
</pre>
        <p>То есть это обычный массив из объектов. Каждый объект — отдельный ресурс.<br> У
            каждого объекта есть три свойства. k — названия ключа в localStorage для этого<br>
            ресурса. p — патч для ресурса, который сгенерировал vcdiff. s — чексумма для<br>
            ресурса актуальной версии, чтобы потом можно было проверить правильность<br>
            наложения патча на клиенте. Чексумма вычисляется по алгоритму Флетчера.</p>
        <math xmlns="http://www.w3.org/1998/Math/MathML">
            <mtext>дано</mtext>
            <mrow>
                <mi>&#949;</mi>
                <mo>,</mo>
                <msub>
                    <mi>X</mi>
                    <mn>&#8320;</mn>
                </msub>
            </mrow><br>
            <mtext>инициализировать</mtext>
            <mrow>
                <msub>
                    <mi>H</mi>
                    <mn>&#8320;</mn>
                </msub>
            </mrow><br>
            <mrow>
                <mi>k</mi>
                <mo>=</mo>
                <mn>0</mn>
            </mrow><br>
            <mtext><B>white</B></mtext>
            <mrow>
                <mo>|</mo>
                <mo>|</mo>
                <mo>&#8711;</mo>
                <msub>
                    <mi>f</mi>
                    <mn>&#954;</mn>
                </msub>
                <mo>|</mo>
                <mo>|</mo>
                <mo>&#62;</mo>
                <mi>&#949;</mi><br>
            </mrow>
            <mtext>найти направление</mtext>
            <mrow>
                <msub>
                    <mi>P</mi>
                    <mn>&#954;</mn>
                </msub>
                <mo>=</mo>
                <msub>
                    <mo>-</mo>
                    <mi>C</mi>
                    <mn>&#954;</mn>
                </msub>
                <mo>&#8711;</mo>
                <msub>
                    <mi>f</mi>
                    <mn>&#954;</mn>
                </msub>
            </mrow><br>
            <mtext>вычислить</mtext>
            <mrow>
                <msub>
                    <mi>X</mi>
                    <mn>&#954;</mn>
                    <mo>+</mo>
                    <mn>1</mn>
                </msub>
                <mo>=</mo>
                <msub>
                    <mi>X</mi>
                    <mn>&#954;</mn>
                </msub>
                <mo>+</mo>
                <msub>
                    <mi>A</mi>
                    <mn>&#954;</mn>
                    <mi>P</mi>
                    <mn>&#954;</mn>
                </msub>
                <mo>,</mo>
                <msub>
                    <mi>A</mi>
                    <mn>&#954;</mn>
                </msub>
                <mtext>удовлетворяет условиям Вольфе</mtext>
            </mrow><br>
            <mtext>обозначить</mtext>
            <mrow>
                <msub>
                    <mi>S</mi>
                    <mn>&#954;</mn>
                </msub>
                <mo>=</mo>
                <msub>
                    <mi>X</mi>
                    <mn>&#954;</mn>
                    <mo>+</mo>
                    <mn>1</mn>
                </msub>
                <mo>-</mo>
                <msub>
                    <mi>X</mi>
                    <mn>&#954;</mn>
                </msub>
                <mtext>и</mtext>
                <msub>
                    <mi>Y</mi>
                    <mn>&#954;</mn>
                </msub>
                <mo>=</mo>
                <msub>
                    <mi>f</mi>
                    <mn>&#954;</mn>
                    <mo>+</mo>
                    <mi>1</mi>
                </msub>
                <mo>-</mo>
                <mo>&#8711;</mo>
                <msub>
                    <mi>f</mi>
                    <mn>&#954;</mn>
                </msub>
            </mrow><br>
            <mtext>вычислить</mtext>
            <mrow>
                <msub>
                    <mi>C</mi>
                    <mn>&#954;</mn>
                    <mo>+</mo>
                    <mn>1</mn>
                </msub>
            </mrow><br>
            <mrow>
                <mi>K</mi>
                <mo>=</mo>
                <mi>K</mi>
                <mo>+</mo>
                <mi>1</mi>
            </mrow><br>
            <mtext><B>end</B></mtext>
        </math>
        <! неполучилось сделать нижний индекс,почему не знаю,тэги вроде правильные>
            <p>Алгоритм Бройдена — Флетчера — Гольдфарба — Шанно
                <abbr title="Алгоритм Бройдена — Флетчера — Гольдфарба — Шанно">(BFGS)</abbr><br>
                — итерационный метод численной оптимизации, предназначенный для<br>
                нахождения локального максимума/минимума нелинейного функционала<br>
                без ограничений.<p>
                    <p>Почему именно алгоритм Флетчера, а не другие популярные алгоритмы вроде:<br>
                        CRC16/32 - алгоритм нахождения контрольной суммы, предназначенный для проверки<br>
                        целостности данных<br>
                        md5 - 128-битный алгоритм хеширования. Предназначен для создания «отпечатков»<br>
                        или дайджестов сообщения произвольной длины и последующей проверки<br>
                        их подлинности.</p>
                    <p>Потому что он быстрый, компактный и легок в реализации.</p>
    </div>
    <div>
        <h3>Итог</h3>
        <p>Фактически мы экономим 80-90% трафика. Размер загружаемой статитки в байтах:</p>
        <table rules="cols">
            <tr>
                <td width="100">Релиз</td>
                <td width="100">С патчем</td>
                <td width="100">Без патча</td>
            </tr>
            <tr>
                <td>7.7.20</td>
                <td>397</td>
                <td>174 549</td>
            </tr>
            <tr>
                <td>7.7.21</td>
                <td>383</td>
                <td>53 995</td>
            </tr>
            <tr>
                <td>7.7.22</td>
                <td>483</td>
                <td>3 995</td>
            </tr>
        </table>
    </div>
    <div>
        <p>Автор: @doochik</p>
        <p>C++ разработчик</p>
        <p>Электронная почта:
            <a href="mailto:doochik@yandex-team.ru">( doochik@yandex-team.ru) </a></p>
        <p>Компания: Яндекс</p>
    </div>
    <div>
        <h4>Комментарии (3) :</h4>
        <p>- Mogaika <a href="mailto:mogaika@yandex-team.ru">( mogaika@yandex-team.ru )</a><time>ноября 2014 в
                17:05</time> </p>
        <p> А можете привести сравнение, на сколько быстрее грузится lite версия?</p>
        <p>- JIguse <a href="mailto:" mrawesome@yandex.ru">( mrawesome@yandex.ru )</a><time>ноября 2014 в 21:30</time>
        </p>
        <p>Спасибо за статью, познавательно. Здорово, что Яндекс делится некоторыми<br>
            подробностями о внутренней работе сервисов.</p>
        <p>- Brister <a href="mailto:" brist89@yandex-team.ru">( brist89@yandex-team.ru )</a><time>24 ноября 2014 в
                13:13</time></p>
        <p>(кол-во счастливых пользователей + кол-во удовлетворенных / 2) / (кол-во всех).<br>
            Получается значение от нуля до единицы, которое, видимо, лучше всего показывает,<br>
            хорошо или плохо работает почта.</p>
        <p>наверное все-таки от 0.5 до 1</p>
        <p>- alexeimois <a href="mailto:test@yandex.ru">( test@yandex.ru )</a><time>ноября 2014 в 17:35</time></p>
        <p>Мы измеряем скорость загрузки с помощью Яндекс.Метрики:<br>
            <a
                href="help.yandex.ru/metrika/reports/monitoring_timing.xml">help.yandex.ru/metrika/reports/monitoring_timing.xml</a>
        </p>
    </div>
    <footer>
        <p>© Яндекс,<a href="help@yandex.ru">help@yandex.ru,</a> Хохрякова, 10</p>
    </footer>
</body>

</html>